#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${repo_root}" ]]; then
  echo "pre-commit: git repository root not found" >&2
  exit 1
fi
cd "${repo_root}"

chart_dir="charts/kube-rca"

if [[ ! -d "${chart_dir}" ]]; then
  exit 0
fi

should_run=false
while IFS= read -r -d '' staged_path; do
  if [[ "${staged_path}" == "${chart_dir}/"* || "${staged_path}" == "${chart_dir}" ]]; then
    should_run=true
    break
  fi
done < <(git -c core.fsmonitor=false diff --cached --name-only -z)

if [[ "${should_run}" != "true" ]]; then
  exit 0
fi

if ! command -v helm >/dev/null 2>&1; then
  echo "pre-commit: 'helm' not found. Install Helm to lint charts." >&2
  exit 1
fi

if ! command -v helm-docs >/dev/null 2>&1; then
  echo "pre-commit: 'helm-docs' not found. Install helm-docs to generate chart docs." >&2
  exit 1
fi

echo "[kube-rca] helm lint ${chart_dir}"
helm lint "${chart_dir}"

echo "[kube-rca] helm-docs (cwd: ${chart_dir})"
(
  cd "${chart_dir}"
  helm-docs
)

if ! git -c core.fsmonitor=false diff --quiet -- "${chart_dir}"; then
  echo "pre-commit: helm-docs generated changes under '${chart_dir}'." >&2
  echo "pre-commit: stage the changes and retry commit." >&2
  git -c core.fsmonitor=false diff --name-only -- "${chart_dir}" >&2 || true
  exit 1
fi
