{{- $auth := default (dict) .Values.backend.auth -}}
{{- $secret := default (dict) $auth.secret -}}
{{- $existingSecret := default "" $secret.existingSecret -}}
{{- if and $auth.enabled (eq $existingSecret "") -}}
{{- $keys := default (dict) $secret.keys -}}
{{- $adminUsernameKey := default "admin-username" $keys.adminUsername -}}
{{- $adminPasswordKey := default "admin-password" $keys.adminPassword -}}
{{- $jwtSecretKey := default "jwt-secret" $keys.jwtSecret -}}
{{- $secretName := include "kube-rca.backend.authSecretName" . -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $existingJwt := "" -}}
{{- if $existing -}}
{{- $existingJwt = (index $existing.data $jwtSecretKey) | default "" -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "kube-rca.backend.labels" . | nindent 4 }}
  {{- $annotations := include "kube-rca.annotations" (dict "root" $ "component" "backend" "annotations" (dict)) | trim }}
  {{- if $annotations }}
  annotations:
{{ $annotations | nindent 4 }}
  {{- end }}
type: Opaque
stringData:
  {{ $adminUsernameKey | quote }}: {{ default "kube-rca" $auth.admin.username | quote }}
  {{ $adminPasswordKey | quote }}: {{ default "kube-rca" $auth.admin.password | quote }}
  {{ $jwtSecretKey | quote }}: {{- if $auth.jwt.secret }} {{ $auth.jwt.secret | quote }}{{- else if $existingJwt }} {{ $existingJwt | b64dec | quote }}{{- else }} {{ randAlphaNum 64 | quote }}{{- end }}
{{- end }}
