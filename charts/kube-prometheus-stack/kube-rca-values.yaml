alertmanager:
  alertmanagerSpec:
    secrets:
      - alertmanager-slack-webhook
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/auth-type: "basic"
      nginx.ingress.kubernetes.io/auth-secret: "basic-auth"
      nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
      external-dns.alpha.kubernetes.io/target: 121.130.214.237
    hosts:
      - alertmanager.kkamji.net
    paths:
      - /
    tls:
      - secretName: alertmanager-tls
        hosts:
          - alertmanager.kkamji.net
  config:
    global:
      resolve_timeout: 5m
    route:
      receiver: 'slack'
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        # Watchdog ì˜ˆì™¸ì²˜ë¦¬
        - receiver: 'null'
          matchers:
            - alertname = "Watchdog"
    receivers:
      - name: 'null'
      - name: 'slack'
        slack_configs:
          - api_url_file: '/etc/alertmanager/secrets/alertmanager-slack-webhook/url'
            send_resolved: true
            title: '{{ .Status | toUpper }}{{ if eq .Status "firing" }} ğŸ”¥{{ else }} âœ…{{ end }} [{{ .CommonLabels.severity | toUpper }}] {{ .CommonLabels.alertname }}'
            text: |-
              {{ range .Alerts }}
              *Alert:* {{ .Labels.alertname }}
              *Severity:* {{ .Labels.severity }}
              *Namespace:* {{ .Labels.namespace }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

grafana:
  admin:
    existingSecret: grafana-auth
    userKey: admin-user
    passwordKey: admin-password
  defaultDashboardsTimezone: browser # TimeZone ì„¤ì • (default: UTC)
  ingress:
    ingressClassName: nginx
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
      external-dns.alpha.kubernetes.io/target: 121.130.214.237
    hosts:
    - grafana.kkamji.net
    path: /
    pathType: Prefix
    tls:
    - secretName: grafana-tls
      hosts:
      - grafana.kkamji.net
  additionalDataSources:
  - name: Loki
    type: loki
    access: proxy
    url: http://loki-gateway:80
    jsonData:
      timeout: 60
      maxLines: 1000
      httpHeaderName1: "X-Scope-OrgID"
    secureJsonData:
      httpHeaderValue1: "kube-rca"

prometheus:
  prometheusSpec:
    additionalScrapeConfigs:
    # Hubble & Cilium Metric ìˆ˜ì§‘ì„ ìœ„í•œ ì„¤ì •
    - job_name: 'kubernetes-pods' ## Cilium
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_scrape ]
        action: keep
        regex: true
      - source_labels: [ __address__, __meta_kubernetes_pod_annotation_prometheus_io_port ]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__

    - job_name: 'kubernetes-endpoints' ## Hubble
      scrape_interval: 30s
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_scrape ]
        action: keep
        regex: true
      - source_labels: [ __address__, __meta_kubernetes_service_annotation_prometheus_io_port ]
        action: replace
        target_label: __address__
        regex: (.+)(?::\d+);(\d+)
        replacement: $1:$2

    retention: 14d
  ingress:
    ingressClassName: nginx
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/auth-type: "basic" # ì¸ì¦ íƒ€ì…
      nginx.ingress.kubernetes.io/auth-secret: "basic-auth" # ì¸ì¦ì— ì‚¬ìš©í•  secret
      nginx.ingress.kubernetes.io/auth-realm: "Authentication Required" # ì¸ì¦ í”„ë¡¬í”„íŠ¸ì— ë³´ë‚´ëŠ” ë©”ì‹œì§€
      external-dns.alpha.kubernetes.io/target: 121.130.214.237
    hosts:
    - prometheus.kkamji.net
    paths:
    - /
    tls:
    - secretName: prometheus-tls
      hosts:
      - prometheus.kkamji.net
