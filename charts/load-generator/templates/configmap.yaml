apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "load-generator.fullname" . }}-script
  labels:
    {{- include "load-generator.labels" . | nindent 4 }}
data:
  script.js: |
    import http from 'k6/http';
    import { check } from 'k6';

    const BASE_URL = __ENV.BASE_URL || 'http://productpage:9080';
    const TARGET_RPS = parseInt(__ENV.TARGET_RPS || '150');

    const PRE_ALLOCATED_VUS = parseInt(__ENV.PRE_ALLOCATED_VUS || '100');
    const MAX_VUS = parseInt(__ENV.MAX_VUS || '500');

    export const options = {
      scenarios: {
        constant_load: {
          executor: 'constant-arrival-rate',
          rate: TARGET_RPS,
          timeUnit: '1s',
          duration: __ENV.DURATION || '24h',
          preAllocatedVUs: PRE_ALLOCATED_VUS,
          maxVUs: MAX_VUS,
        },
      },
      discardResponseBodies: true,
      thresholds: {
        http_req_failed: ['rate<0.9'],
        http_req_duration: ['p(95)<10000'],
      },
    };

    const endpoints = [
      { path: '/productpage', weight: 60 },
      { path: '/api/v1/products', weight: 15 },
      { path: '/api/v1/products/0/reviews', weight: 15 },
      { path: '/api/v1/products/0/ratings', weight: 10 },
    ];

    function selectEndpoint() {
      const rand = Math.random() * 100;
      let cumulative = 0;
      for (const ep of endpoints) {
        cumulative += ep.weight;
        if (rand <= cumulative) {
          return ep.path;
        }
      }
      return endpoints[0].path;
    }

    export default function () {
      const endpoint = selectEndpoint();
      const url = `${BASE_URL}${endpoint}`;

      const res = http.get(url, {
        timeout: '10s',
        tags: { endpoint: endpoint },
      });

      check(res, {
        'status ok': (r) => r.status >= 200 && r.status < 400,
      });
    }
